services:
  # =============================================================================
  # Proxmox Commander - Main Application
  # =============================================================================

  dpc-web:
    image: ghcr.io/dvaper/pve-commander/dpc-web:${VERSION:-latest}
    container_name: pve-commander-web
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
    depends_on:
      dpc-api:
        condition: service_healthy
    environment:
      - TZ=${TZ:-Europe/Berlin}
    # HIGH-06: Healthcheck fuer Frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - pve-commander

  dpc-api:
    image: ghcr.io/dvaper/pve-commander/dpc-api:${VERSION:-latest}
    container_name: pve-commander-api
    restart: unless-stopped
    # Docker Socket Zugriff: GID der docker-Gruppe auf dem Host
    # Ermitteln mit: stat -c '%g' /var/run/docker.sock
    group_add:
      - ${DOCKER_GID:-999}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      netbox:
        condition: service_started
    # HIGH-06: Healthcheck fuer API
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    env_file:
      - path: ./data/config/.env
        required: false
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DEBUG=${DEBUG:-false}
      - NETBOX_URL=http://netbox:8080
      # NETBOX_TOKEN wird aus env_file geladen (Setup-Wizard)
      - DATA_DIR=/data
      - INVENTORY_DIR=/data/inventory
      - PLAYBOOKS_DIR=/data/playbooks
      - ROLES_DIR=/data/roles
      - TERRAFORM_DIR=/data/terraform
      - SSH_KEY_PATH=/data/ssh/id_ed25519
      - ENV_FILE=/data/config/.env
      # Proxmox API, Ansible, SSH werden aus /data/config/.env gelesen
      # (wird vom Setup-Wizard erstellt)
    volumes:
      - ./data/db:/data/db
      - ./data/inventory:/data/inventory
      - ./data/playbooks:/data/playbooks
      - ./data/roles:/data/roles
      - ./data/terraform:/data/terraform
      - ./data/ssh:/data/ssh
      - ./data/config:/data/config
      - /var/run/docker.sock:/var/run/docker.sock
      # Optional: Host SSH-Keys fuer Import im Setup-Wizard
      # Aktivieren um bestehende SSH-Keys zu importieren:
      # - ~/.ssh:/host-ssh:ro
    networks:
      - pve-commander

  # =============================================================================
  # NetBox - IPAM & DCIM
  # =============================================================================

  netbox:
    image: netboxcommunity/netbox:${NETBOX_VERSION:-v4.0}
    container_name: pve-commander-netbox
    restart: unless-stopped
    # Port 8081 fuer direkten Zugriff auf NetBox UI
    ports:
      - "${NETBOX_PORT:-8081}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # NetBox Credentials aus Setup-Wizard laden (fuer Container-Restart)
    env_file:
      - path: ./data/config/.env
        required: false
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - CORS_ORIGIN_ALLOW_ALL=True
      - DB_HOST=postgres
      - DB_NAME=netbox
      - DB_USER=netbox
      - DB_PASSWORD=${POSTGRES_PASSWORD:-netbox}
      - REDIS_HOST=redis
      - SECRET_KEY=${NETBOX_SECRET_KEY:-netbox-default-secret-key-change-me-in-production-min-50-chars}
      # Superuser wird vom Setup-Wizard via sync_netbox_superuser() erstellt
      # SKIP_SUPERUSER=true verhindert doppelte User bei Erstinstallation
      - SUPERUSER_API_TOKEN=${NETBOX_TOKEN:-0123456789abcdef0123456789abcdef01234567}
      - SKIP_SUPERUSER=true
    volumes:
      - ./data/netbox/media:/opt/netbox/netbox/media
      - ./data/netbox/reports:/opt/netbox/netbox/reports
      - ./data/netbox/scripts:/opt/netbox/netbox/scripts
    networks:
      - pve-commander

  netbox-worker:
    image: netboxcommunity/netbox:${NETBOX_VERSION:-v4.0}
    container_name: pve-commander-netbox-worker
    restart: unless-stopped
    depends_on:
      netbox:
        condition: service_started
    command: /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - DB_HOST=postgres
      - DB_NAME=netbox
      - DB_USER=netbox
      - DB_PASSWORD=${POSTGRES_PASSWORD:-netbox}
      - REDIS_HOST=redis
      - SECRET_KEY=${NETBOX_SECRET_KEY:-netbox-default-secret-key-change-me-in-production-min-50-chars}
    volumes:
      - ./data/netbox/media:/opt/netbox/netbox/media
      - ./data/netbox/reports:/opt/netbox/netbox/reports
      - ./data/netbox/scripts:/opt/netbox/netbox/scripts
    networks:
      - pve-commander

  netbox-housekeeping:
    image: netboxcommunity/netbox:${NETBOX_VERSION:-v4.0}
    container_name: pve-commander-netbox-housekeeping
    restart: unless-stopped
    depends_on:
      netbox:
        condition: service_started
    command: /opt/netbox/housekeeping.sh
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - DB_HOST=postgres
      - DB_NAME=netbox
      - DB_USER=netbox
      - DB_PASSWORD=${POSTGRES_PASSWORD:-netbox}
      - REDIS_HOST=redis
      - SECRET_KEY=${NETBOX_SECRET_KEY:-netbox-default-secret-key-change-me-in-production-min-50-chars}
    networks:
      - pve-commander

  # =============================================================================
  # Database & Cache
  # =============================================================================

  postgres:
    image: postgres:16-alpine
    container_name: pve-commander-postgres
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - POSTGRES_USER=netbox
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-netbox}
      - POSTGRES_DB=netbox
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netbox"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pve-commander

  redis:
    image: redis:7-alpine
    container_name: pve-commander-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    environment:
      - TZ=${TZ:-Europe/Berlin}
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pve-commander

networks:
  pve-commander:
    driver: bridge

# Alle Daten liegen unter ./data/ (Bind Mounts statt Named Volumes)
# Bei Loeschen des Installationsverzeichnisses werden alle Daten geloescht
